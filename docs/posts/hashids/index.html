<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>hashids-内外标识符转换方案 | 搬砖手账</title><link rel=icon type=image/x-icon><link rel=stylesheet href=//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css><link rel=stylesheet href=//cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.2/build/styles/rainbow.min.css><link rel=stylesheet href="/static/style.min.css?v=fd2144" integrity media=screen></head><body><header class="lay-header box-header"></header><div class=lay-wrapper><aside class="lay-aside box-aside"><div class=box-shadow-without-top><div class=box-logo><a href=https://hankmew.com/>搬砖手账</a><p>沉心营浮世，热血饮凉冰</p><div class=box-menu-toggle id=id-menu-toggle><button>
<span></span><span></span><span></span></button></div></div><nav class="box-nav bg-white box-nav-min-hiden" id=id-menu><div><a href=/><i class="fa fa-fw fa-home fa-home"></i>Home</a></div><div><a href=/about><i class="fa fa-fw fa-home fa-user-md"></i>About</a></div><div class=box-nav-active><a href=/posts><i class="fa fa-fw fa-home fa-archive"></i>Archives</a></div><div><a href=/tags><i class="fa fa-fw fa-home fa-tag"></i>Tags</a></div></nav></div><div class="box-ref box-shadow bg-white" id=id-fix><div class=box-toc><nav id=TableOfContents><ul><li><a href=#遇到的问题>遇到的问题</a></li><li><a href=#问题本质>问题本质</a></li><li><a href=#一些方案>一些方案</a></li><li><a href=#hashids方案>hashids方案</a></li><li><a href=#用法>用法</a></li><li><a href=#安全与性能>安全与性能</a></li><li><a href=#总结>总结</a></li></ul></nav></div><div class=box-backtop id=id-backtop><i class="fa fa-arrow-up"></i><span></span></div></div></aside><main class="lay-main box-main"><div class="box-main-min bg-white box-main-padding box-shadow-without-top box-post"><article><div class=box-post-title>hashids-内外标识符转换方案</div><div class=box-post-meta><i class="fa fa-fw fa-calendar-check-o"></i>2019/03/13
<span>|</span>
<i class="fa fa-fw fa-keyboard-o"></i>1430
<span>|</span>
<i class="fa fa-fw fa-tags"></i>hashids</div><div class=typ-article><h2 id=遇到的问题>遇到的问题</h2><p>有些用户系统，会为用户分配两个唯一标识。一个是内部流转用的，一个是对外展示用的。前者会在中间件和程序中流转，想看到该值的必须条件是有访问权限。后者会出现在需要被人看到、可以口头流转的地方，比如用户账号页面、管理后台、日志打印用户标识。</p><p>内外都只用一个标识不行吗？当然可以。demo级别的小玩具或者急于交付的外包项目当然可以这么干。但是一个互联网项目绝对不可以这么做。即便再迫切的想要赶工上线，这些会严重影响后续发展的基础工作也必须要做。这些基础打不牢，轻则需要花费很大的精力去改造升级，重则直接被这些小细节击垮。</p><p>为什么要把用户的唯一标识做内外区分呢。原因无非有以下几点：</p><ul><li>对内标识的设计受数据库存储形式的影响，考虑到性能问题，无论是否是分布式生成的id，一般都会选择用趋势递增的数字做对内标识，而且大概率会在数据库中做主键。将主键暴露在外，一旦黑客攻入内网，直接就可以使用已知id和递增的规律进行攻击。</li><li>用户存量和用户增长量是公司较为敏感的数据。如果将内部标识暴露在外，友商直接知道了用户存量，早晚各注册一次，又可以知道了每日用户增量。从而制定针对公司不利的策略。</li><li>有些接口会以递增的用户id做查询条件，如果将内部标识暴露在外，爬虫可以按顺序轻易的爬走用户数据。</li></ul><h2 id=问题本质>问题本质</h2><p>该问题的本质，可以理解成需要满足如下条件的内外标识转换问题：</p><ul><li>可唯一的进行相互转换</li><li>仅可在服务端转换</li><li>对外标识是唯一的、散列的、无序的</li></ul><p>最好还要满足以下额外需求</p><ul><li>有最小散列长度</li><li>对外的标识可读性要好</li><li>使用算法而不是对应表的方式解决</li></ul><h2 id=一些方案>一些方案</h2><p>【加随机数】 在对内标志的指定位置增加若干随机数，并在数据库中存储，需要时再进行查库转换。好处：1.处理非常简单。2.转换结果易读；坏处：1.加随机数的位置容易被猜出来。2.使用数据库转换容易变成瓶颈。</p><p>【BASE64】将对内标识直接base64做对外标识，直接使用工具类转换。好处：1.处理非常简单。2.转换结果位数少；坏处：1.可直接被反解码。2.得到的对外标识不好读。</p><p>【AES】将内部标识使用秘钥对称加密，秘钥存在服务器。好处：1.相对安全。坏处：1.得出的结果位数较长。2.不好读。</p><h2 id=hashids方案>hashids方案</h2><p>上面的几种方案在安全、易读、位数少等方面均不能完全满足。这个时候，hashids方案便应运而生了。</p><blockquote><p>generate short unique ids from integers</p></blockquote><p>如hashids对自己的说明，hashids可以将数字转换为较短的唯一标识。支持的语言非常多。且调用非常方便。详细的介绍可以戳官网 <a href=https://hashids.org/>https://hashids.org/</a></p><p>其核心思路是：将输入的数字和盐，转换成一个较短的唯一字符串。该字符串可以设定成仅用某些字符。生成的字符串还可以使用盐还原成数字。盐放在服务器端。</p><h2 id=用法>用法</h2><p>这里以Java为例。</p><p>1.使用maven获取依赖</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;dependency&gt;</span>
    <span style=color:#f92672>&lt;groupId&gt;</span>org.hashids<span style=color:#f92672>&lt;/groupId&gt;</span>
    <span style=color:#f92672>&lt;artifactId&gt;</span>hashids<span style=color:#f92672>&lt;/artifactId&gt;</span>
    <span style=color:#f92672>&lt;version&gt;</span>1.0.3<span style=color:#f92672>&lt;/version&gt;</span>
<span style=color:#f92672>&lt;/dependency&gt;</span>
</code></pre></div><p>2.加密</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// 初始化时设定盐、结果最小长度、映射字符集（最短16位且不能重复）
</span><span style=color:#75715e></span>Hashids hashids <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Hashids<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;this is my salt&#34;</span><span style=color:#f92672>,</span> 8<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;1234567890ABCDEF&#34;</span><span style=color:#f92672>);</span>
String hash <span style=color:#f92672>=</span> hashids<span style=color:#f92672>.</span><span style=color:#a6e22e>encode</span><span style=color:#f92672>(</span>12345L<span style=color:#f92672>);</span>

<span style=color:#75715e>// 得到的字符串为
</span><span style=color:#75715e></span>BEB47D7E
</code></pre></div><p>3.解密</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// 初始化设定的参数需要与加密时的保持相同
</span><span style=color:#75715e></span>Hashids hashids <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Hashids<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;this is my salt&#34;</span><span style=color:#f92672>,</span> 8<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;1234567890ABCDEF&#34;</span><span style=color:#f92672>);</span>
<span style=color:#66d9ef>long</span><span style=color:#f92672>[]</span> numbers <span style=color:#f92672>=</span> hashids<span style=color:#f92672>.</span><span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;BEB47D7E&#34;</span><span style=color:#f92672>);</span>

<span style=color:#75715e>// 解码出来的是数字型数组。注意判空
</span><span style=color:#75715e></span><span style=color:#f92672>[</span> 12345 <span style=color:#f92672>]</span>
</code></pre></div><p>使用就是这么简单，由于本文偏方案选取，具体hashids的使用细节请在官网查看。</p><h2 id=安全与性能>安全与性能</h2><p>在安全性上，虽然hashids较AES弱些，但破解起来还是有很高的门槛。且解密出的数据并不是敏感度最高的密码。投入产出比太低。</p><p>在性能上，实际测试结果来看，加密十万条仅需要花费120毫秒。无需考虑效率问题。</p><h2 id=总结>总结</h2><p>从各方面综合考虑，hashids是解决用户id、订单id内外转换问题的优秀方案。</p></div></article><div class=box-license>本文档创作遵循
<a target=_blank href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh>「署名-非商业性使用-禁止演绎 4.0 国际版 (CC BY-NC-ND 4.0)」</a></div><div class=box-article-nav><a href=/posts/mybatis-batch-update/><i class="fa fa-chevron-left"></i><span>批量执行SQL-以MyBatis为例</span></a>
<a href=/posts/mysql-and-hikaricp-config/><span>MySQL与HikariCP</span><i class="fa fa-chevron-right"></i></a></div></div></main></div><footer class="lay-footer box-footer"><span>Copyright
&nbsp;&copy;
&nbsp;2019-2021
&nbsp;<a href=https://hankmew.com/>汉克喵</a>,
&nbsp;All Rights Reserved.</span></footer><script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.2/build/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><script type=text/javascript src="/static/script.min.js?v=e95e58" integrity></script></body></html>