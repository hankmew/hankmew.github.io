<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>如何结算指定时区的订单 | 搬砖手账</title><link rel=icon type=image/x-icon><link rel=stylesheet href=//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css><link rel=stylesheet href=//cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.2/build/styles/rainbow.min.css><link rel=stylesheet href="/static/style.min.css?v=822c8e" integrity media=screen></head><body><header class="lay-header box-header"></header><div class=lay-wrapper><aside class="lay-aside box-aside"><div class=box-shadow-without-top><div class=box-logo><a href=https://hankmew.com/>搬砖手账</a><p>沉心营浮世，热血饮凉冰</p><div class=box-menu-toggle id=id-menu-toggle><button>
<span></span><span></span><span></span></button></div></div><nav class="box-nav bg-white box-nav-min-hiden" id=id-menu><div><a href=/><i class="fa fa-fw fa-home fa-home"></i>Home</a></div><div><a href=/about><i class="fa fa-fw fa-home fa-user-md"></i>About</a></div><div class=box-nav-active><a href=/posts><i class="fa fa-fw fa-home fa-archive"></i>Archives</a></div><div><a href=/tags><i class="fa fa-fw fa-home fa-tag"></i>Tags</a></div></nav></div><div class="box-ref box-shadow bg-white" id=id-fix><div class=box-toc><nav id=TableOfContents><ul><li><a href=#通用规范>通用规范</a></li><li><a href=#遇到问题>遇到问题</a></li><li><a href=#探索方案>探索方案</a></li><li><a href=#注意点>注意点</a></li></ul></nav></div><div class=box-backtop id=id-backtop><i class="fa fa-arrow-up"></i><span></span></div></div></aside><main class="lay-main box-main"><div class="box-main-min bg-white box-main-padding box-shadow-without-top box-post"><article><div class=box-post-title>如何结算指定时区的订单</div><div class=box-post-meta><i class="fa fa-fw fa-calendar-check-o"></i>2019/06/17
<span>|</span>
<i class="fa fa-fw fa-keyboard-o"></i>997
<span>|</span>
<i class="fa fa-fw fa-tags"></i>timestamp</div><div class=typ-article><h2 id=通用规范>通用规范</h2><p>如果需要处理的时间是当前和未来的时间，则使用长整型毫秒级时间戳进行存储和计算。</p><p>遵循存储与显示分离的策略。服务端存储整型时间戳，客户端显示格式化结果。</p><p>如：用户创建一笔订单，服务器以自己的时间为基准生成长整型毫秒级时间戳作为该笔订单的创建时间，然后存入数据库。用户查看该笔订单时，服务器从数据库中取出该笔订单并返回，客户端根据所在时区格式化成指定时间格式。</p><h2 id=遇到问题>遇到问题</h2><p>通用规范中，服务器是不知道有时区这个概念的，时区只是客户端用来格式化的一个偏移量。</p><p>如果程序需要根据指定时区来处理某些业务，即服务器端要有时区概念。则有没有一套比较好的方案。</p><p>如：电商系统，以东京时间凌晨两点结算过去一天的订单总量。服务器默认时区是北京时区，数据库存储的是长整型毫秒级时间戳。</p><h2 id=探索方案>探索方案</h2><p>先给出一个公式：</p><blockquote><p>指定日期时间 - 偏移量 - 绝对起始时间常量 = 时间戳</p></blockquote><pre><code>xxxx年xx日xx时xx分xx秒 - 偏移几个小时如+8:00 - 1970年01月01日00时00分00秒 = 时间戳
</code></pre><p>除去绝对起始时间常量外，已知任意两个变量可以求出第三个变量</p><p>考虑，东京时间的2019年8月15日当天的时间戳范围是多少，与北京时间的2019年8月15日的时间戳范围是一样的吗？</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>//东京2019年8月15日0时0分0秒的时间戳：
</span><span style=color:#75715e></span>ZonedDateTime<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;2019-08-15T00:00:00.000+09:00&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>toInstant</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toEpochMilli</span><span style=color:#f92672>();</span>
<span style=color:#75715e>//得出  1565794800000
</span><span style=color:#75715e></span>
<span style=color:#75715e>//北京2019年8月15日0时0分0秒的时间戳：
</span><span style=color:#75715e></span>ZonedDateTime<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;2019-08-15T00:00:00.000+08:00&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>toInstant</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toEpochMilli</span><span style=color:#f92672>();</span>
<span style=color:#75715e>//得出  1565798400000
</span></code></pre></div><p>可以看出，两个不同时区的起始时间的时间戳是不同的。可以想象，不论用哪个时区，只要时间过一毫秒，时间戳就加1。而东京先看到太阳，此刻时间戳为a。而北京要过一小时后才看到太阳，此刻时间戳记为b。而a加一小时才等于b，所以a要比b小。</p><p><strong>结论</strong>：同一个本地时间，时区偏移量越大的，其时间戳越小。</p><p>经过上面的讨论。可以形成一个思路去解决上面遇到的问题：</p><ol><li><p>使用cron表达式，指定时区指定时间执行任务。</p></li><li><p>任务开始，计算东京时间2019年8月15日0时0分0秒的时间戳作为起始时间，计算东京时间2019年8月15日23点59分59秒的时间戳作为终止时间。扫描表中创建时间在这两个范围内的订单。则扫描到的订单均为东京时间2019年8月15日生成的。</p></li></ol><h2 id=注意点>注意点</h2><ol><li><p>此类逻辑处理完全依赖于业务是否考虑使用指定时区。如果不指定，则默认使用服务器的本地时可以解决。如果指定，则需要完整的考虑时区问题。</p></li><li><p>如果业务有时区问题，需要发布公告完善的指明业务支持的时区问题，规避非指定时区的人使用服务时造成的困扰。</p></li></ol></div></article><div class=box-license>本文档创作遵循
<a target=_blank href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh>「署名-非商业性使用-禁止演绎 4.0 国际版 (CC BY-NC-ND 4.0)」</a></div><div class=box-article-nav><a href=/posts/trilium-notes/><i class="fa fa-chevron-left"></i><span>Trilium Notes 个人云笔记</span></a>
<a href=/posts/mybatis-batch-update/><span>批量执行SQL-以MyBatis为例</span><i class="fa fa-chevron-right"></i></a></div></div></main></div><footer class="lay-footer box-footer"><span>Copyright
&nbsp;&copy;
&nbsp;2019-2021
&nbsp;<a href=https://hankmew.com/>汉克喵</a>,
&nbsp;All Rights Reserved.</span></footer><script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.2/build/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><script type=text/javascript src="/static/script.min.js?v=e95e58" integrity></script></body></html>