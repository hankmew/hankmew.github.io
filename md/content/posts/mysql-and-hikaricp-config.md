---
title: "MySQL与HikariCP"
tags: ["mysql", "hikaricp"]
date: 2019-02-18T19:56:45+08:00
draft: false
typora-root-url: ../
---

## 综述

作为开发后端的Java程序员，除了语言本身，中间件的使用也是衡量水平的标准之一。特别是以MySQL为代表的数据库，优秀的开发者可以根据不同的需求，调整不同的方案，扬长避短，用出更好的效果。反之，如果只用默认配置，或者没有经过论证就胡乱使用配置，和容易造成性能瓶颈。

程序员使用MySQL，基础的有两点，一个是客户端参数配置，另外一个sql语句。本系列着重探究HikariCP作为客户端时的参数配置。

## 连接池连接数量与超时时间

数据库连接池存在的目的，就是为了避免频繁创建与销毁与数据库服务的网络会话连接。其核心解决的问题是需要如何维护按需增减的连接数。

Java连接池的解决逻辑一般是：

1. 系统初始化时，首先访问数据库，如果在initializationFailTimeout时间内还没能成功访问，则抛出无法初始化的异常，系统初始化失败。如果可以访问到数据库，则创建minimumIdle个数据库会话连接。

2. 系统处理用户的访问请求逐步增多。服务需要访问数据库时，则向连接池申请一个空闲连接。如果这个时候有空闲连接，则分配一个空闲连接。如果这个时候没有空闲连接，则会再创建一个。用户访问导致不断创建连接数数量达到maximumPoolSize数量。后面再进来的请求会被阻塞住以等待其他请求释放连接，如果等待时间超过connectionTimeout时返回异常。

3. 系统处理用户的访问请求逐步减少。创建的连接数大于minimumIdle数量，但是有空闲连接。则这些连接的空闲时间大于idleTimeout时，会被连接池释放掉。最终使得连接数等于minimumIdle。访问量进一步减少，连接数等于minimumIdle，但是还是有空闲连接。空闲连接时间超过maxLifetime时，连接池会刷新该连接，保证不被MySQL主动断掉，同时重置空闲时间。

|HikariCP配置项|单位|默认值|说明|
|:-|:-|:-|:-|
|minimumIdle|个|与maximumPoolSize相同|连接池与数据库保持连接数量的最小值,官方建议不要设置此值而保持默认|
|maximumPoolSize|个|10|连接池中允许的最大连接数。推荐的公式：((core_count * 2) + effective_spindle_count)|
|idleTimeout|毫秒|600000（10分钟）|空闲时间超过多久后，该连接被释放掉|
|maxLifetime|毫秒|1800000（30分钟）|空闲时间超过多久后，该连接被刷新。一定要小于MySQL服务器的wait-timeout值。繁忙的系统该值不要设置过大|
|connectionTimeout|毫秒|30000 (30分钟)|向连接池申请连接时等待的最长时间|
|validationTimeout|毫秒|5000|验证连接是否有效时的超时时间|
|initializationFailTimeout|毫秒|1|在超时期间内无法初始化成功连接池，则抛出异常。如果设置为0，会尝试重连，重连失败则抛异常终止连接池，小于0表示不重连，默认值1|







